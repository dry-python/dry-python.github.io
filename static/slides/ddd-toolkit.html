<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="Domain Driven Design Toolkit"><meta name="author" content="Artem Malyshev"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Domain Driven Design Toolkit</title><link href="reveal.css" rel="stylesheet"></head><body><div class="reveal"><div class="slides"><section data-background-image="c67acaebb427d500c2dacf02aa932597.png" data-background-size="auto,100%"><h2>Domain Driven Design Toolkit</h2><h4><a href="https://github.com/proofit404">Artem Malyshev</a></h4></section><section><h2>BIO</h2><ul><li>5 years of experience in Python</li><li>Django Channels 1.0</li><li>Dry Python</li></ul></section><section><h2>Complexity</h2><p class="fragment"><b>Accidental complexity</b> refers to challenges that developers unintentionally make for themselves as a result of trying to solve a problem.</p><p class="fragment"><b>Essential complexity</b> is just the nature of the beast you're trying to tame.</p></section><section data-background-image="2b604a464cb281a0eae3e8aede49ea2b.jpg" data-background-size="contain"></section><section data-background-image="cf1c78890006e078a538842a0caa7127.jpg" data-background-size="contain"></section><section><h2>Accidental complexity</h2><ul><li class="fragment">AsyncIO vs. Gevent</li><li class="fragment">PostgreSQL vs. MongoDB</li><li class="fragment">Python vs. Go</li><li class="fragment">Emacs vs. Vim</li><li class="fragment">Tabs vs. Spaces</li></ul></section><section><img class="plain" src="84967f7293cc96c87fa15b8ba857824f.jpg"></section><section><h2>What is the domain-driven design?</h2><p class="fragment">Focus on the core complexity and opportunity in the domain</p><p class="fragment">Explore models in a collaboration of domain experts and software experts</p><p class="fragment">Write software that expresses those models explicitly</p><p class="fragment">Speak <b>ubiquitous language</b> within a <b>bounded context</b></p></section><section><h2>Not about technology</h2><p class="fragment">You have to master the tool first then you can focus on <b>DDD</b>.</p><p class="fragment">In most domain models, most design patterns are technical noise.</p></section><section><img class="plain" src="37edc99461b0b0e09cf52c9b89217f62.jpg"></section><section data-background-image="a1e03b421dfec7d4299ee5f88724a5fe.jpg" data-background-size="contain"></section><section data-background-image="2a4f9d033642fd35ff0ae38b60e040b8.jpg" data-background-size="contain"></section><section><h2>What is a model?</h2><p class="fragment"><b>HINT:</b> Not a UML diagram</p><p class="fragment">A set of services, entities and value objects expressed in classes, methods, and refs.</p></section><section><h2><a href="https://dry-python.org/">dry-python</a></h2><p>A set of libraries for pluggable business logic components.</p><img class="plain" src="https://raw.githubusercontent.com/dry-python/brand/master/logo/dry-python.png"></section><section data-background-image="dfa51ec6d49a3dd72fa893c5f11dd52b.jpg" data-background-size="contain"></section><section><img class="plain" src="https://raw.githubusercontent.com/dry-python/brand/master/logo/stories.png"><p>Define a user story in the business transaction DSL.</p><p>Separate state, implementation and specification.</p></section><section><h2>Layout</h2><pre><code>project
├── admin
├── forms
├── migrations
├── models
├── <b>services</b>
├── templates
└── views</code></pre></section><section><h2>Specification DSL</h2><pre><code class="python">from stories import story, arguments

class Subscription:
    @story
    @arguments("invoice_id", "user")
    def buy(I):
        I.find_order
        I.find_price
        I.find_invoice
        I.check_balance
        I.persist_payment
        I.persist_subscription
        I.send_subscription_notification</code></pre></section><section><h2>State Contract</h2><pre><code class="python">from pydantic import BaseModel

class Subscription:
    @story
    def buy(I):
        ...

@Subscription.buy.contract
class Context(BaseModel):
    user: User
    invoice_id: int
    invoice: Optional[Invoice]</code></pre></section><section><h2>Steps implementation</h2><pre><code class="python">from stories import Failure, Success

class Subscription:

    def find_invoice(self, ctx: Context):
        invoice = Invoice.objects.get(pk=ctx.invoice_id)
        return Success(invoice=invoice)

    def check_balance(self, ctx: Context):
        if ctx.user.can_pay(ctx.invoice):
            return Success()
        else:
            return Failure()</code></pre></section><section><h2>Story Execution</h2><pre><code class="python">>>> Subscription().buy(category_id=2)
Subscription.buy:
  find_category
  check_price
  check_purchase (PromoCode.validate)
    find_code (skipped)
  check_balance
    find_profile

Context:
  category_id = 1318  # Story argument
  user = &lt;User: 3292&gt; # Story argument
  category = &lt;Category: 1318&gt;
    # Set by Subscription.find_category</code></pre></section><section data-background-image="0b268941b08e07b82b1982ba847f31ec.png" data-background-size="contain"><h2>DEBUG TOOLBAR</h2><br><br><br><br><br><br><br><br><br><br></section><section data-background-image="335b1cb95d5010bb26e11d96f39114bc.png" data-background-size="contain"><h2 style="color: white">py.test</h2></section><section data-background-image="47641827d2ab3c50d8b8976d9dd59c05.png" data-background-size="contain"><h2>Sentry</h2></section><section data-background-image="322f6c659ff69a70b4a9392f80eba983.gif" data-background-size="contain"><h2>ELK</h2></section><section data-background-image="2f8fdc259c046cefdd4211db709ef31e.jpg" data-background-size="contain"></section><section data-background-image="865ecfe3219b7f6cf803154b2ca0ac15.jpg" data-background-size="contain"></section><section data-background-image="3e46dde7d79e42928005ac9621dcf5b0.jpg" data-background-size="contain"></section><section data-background-image="f52dca54c7d19aa4e400bc02d4286a36.jpg" data-background-size="contain"></section><section data-background-image="10ba34ef6a86d1beaae211015976e82d.jpg" data-background-size="contain"></section><section data-background-image="1d67e254d9328fd7e779fe489f2c0782.jpg" data-background-size="contain"></section><section><h2>Layout</h2><pre><code>project
├── admin
├── <b>aggregates</b>
├── forms
├── migrations
├── models
├── services
├── templates
└── views</code></pre></section><section><h2>dataclasses</h2><pre><code class="python">from dataclasses import dataclass
from typing import List, NewType

OrderId = NewType("OrderId", int)

@dataclass
class LineItem:
    product_id: ProductId

@dataclass
class Order:
    primary_key: OrderId
    items: List[LineItem]</code></pre></section><section data-background-image="a6d4253cc3f40f8c0afaf6ab22e33bc5.jpg" data-background-size="contain"></section><section><img class="plain" src="https://raw.githubusercontent.com/dry-python/brand/master/logo/mappers.png"><p>Declarative mappers from ORM models to domain entities. And back again!</p></section><section><h2>Layout</h2><pre><code>project
├── admin
├── aggregates
├── forms
├── migrations
├── models
├── <b>repositories</b>
├── services
├── templates
└── views</code></pre></section><section><h2>Django ORM</h2><pre><code class="python">from mappers import Mapper
from app.aggregates import Order, OrderId, User
from app.models import OrderModel, UserModel

mapper = Mapper(Order, OrderModel, {"primary_key": "pk"})

@mapper.reader
def load_order(id: OrderId, user: User) -> Order:
    friends = UserModel.objects.filter(
        purchases=OuterRef("pk"), friends=user.primary_key)
    return OrderModel.objects.filter(pk=id).annotate(
        purchased_by_friends=Exists(friends)).get()</code></pre></section><section><h2>Swagger definitions</h2><pre><code class="python">from mappers import Mapper
from bravado import swagger_model
from app.aggregates import Price

spec = swagger_model.load_file("price_service.yml")
mapper = Mapper(Price, spec.definitions["Price"])

@mapper.reader
def load_price(id: PriceId) -> Price:
    return requests.get(f"http://172.16.1.7/get/{id}")</code></pre></section><section><h2>GraphQL queries</h2><pre><code class="python">from mappers import Mapper
from gql import gql, Client, build_schema
from app.models import Invoice

schema = build_schema("invoice_service.graphql")
mapper = Mapper(Invoice, schema.get_type_map()["Invoice"])

@mapper.reader
def load_invoice(id: InvoiceId) -> Invoice:
    return Client(schema=schema).execute(gql("""
      {
        loadInvoice(id: %(id)d)
      }
    """, {"id": id}))</code></pre></section><section data-background-image="875c0a54b996419ed89e96841c2f5cba.png" data-background-size="contain"></section><section><h2>Tests & Mocks</h2><pre><code class="python">def test_before(monkeypatch):
    monkeypatch.setattr(pusher, "Pusher", Mock())
    # ...
    pusher.Pusher.trigger.assert_called_once_with(
        "private-user-1"
    )

def test_after(emitter):
    # ...
    emitter.trigger.assert_called_once_with(
        UserStream(User(primary_key=1))
    )</code></pre></section><section><img class="plain" src="https://raw.githubusercontent.com/dry-python/brand/master/logo/dependencies.png"><p>Provide composition instead of inheritance.</p><p>Solves top-down approach problem.</p></section><section><h2>Dependency Injection</h2><pre><code class="python">from dependencies import Injector, Package

app = Package("project")

class BuySubscription(Injector):

    buy_subscription = app.services.Subscription.buy
    load_order = app.repositories.load_order
    load_price = app.repositories.load_price
    load_invoice = app.repositories.load_invoice

BuySubscription.buy_subscription(category_id=1, price_id=1)</code></pre></section><section><h2>Refactoring roadmap</h2><ul><li class="fragment">No DDD at all</li><li class="fragment">Stories without contracts</li><li class="fragment">Contracts and aggregates</li><li class="fragment">Mappers</li><li class="fragment">Dependency injection</li></ul></section><section data-background-image="20d08f27a15381221fdc43d57c52831f.png" data-background-size="contain"></section><section><h2>Questions?</h2></section></div></div><script type="text/javascript" src="reveal.js"></script></body></html>