<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="Keeping Software Soft"><meta name="author" content="Artem Malyshev"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Keeping Software Soft</title><link href="reveal.css" rel="stylesheet"></head><body><div class="reveal"><div class="slides"><section><h2>Keeping Software Soft</h2><h4><a href="https://github.com/proofit404">Artem Malyshev</a></h4><h6><a href="https://twitter.com/proofit404">@proofit404</a></h6></section><section data-background-image="aeb65fa2de1c0896782fd5008bf3d33b.jpg" data-background-size="contain" data-background-position="right" data-background-color="#000000"><br></section><section><h2>BIO</h2><ul><li>Co-Founder at <a href="https://drylabs.io/">drylabs.io</a></li><li><a href="https://dry-python.org/">dry-python.org</a></li><li>Django Channels 1.0</li><li>5 years of experience in Python</li></ul></section><section data-background-image="f59f3c8af01ae12346e23c4ec6b68d06.png" data-background-size="contain" data-background-color="#2E677B"><br></section><section data-background-image="20bc26206f6e89782a910352143e4b58.png" data-background-size="contain"><br></section><section><img class="plain" src="d2f574f2f5969574d22416673cb3b4f2.png" height="100" style=" padding-right: 70px;"><img class="plain" src="98ff4822d03ab0f5746653f56441d38e.png" height="100" style=" padding-right: 70px;"><img class="plain" src="c1aa1da6346bdb04a0ac8b161090b0f0.png" height="100" style=" padding-right: 70px;"><aside class="notes"><p>несторуктурированный проект на фласке синатре</p></aside></section><section data-background-image="53997124e1acc9aa28c273b0daa540b3.jpg" data-background-size="contain"><br><aside class="notes"><p>тут мы json валидируем</p><p>тут мы в базу ходим</p><p>а тут в письма рассылаем</p><p>всё в функциях по 1000 строк кода</p></aside></section><section><h2>pros</h2><ol><li class="fragment">Relatively easy to read</li></ol><h2 class="fragment">cons</h2><ol><li class="fragment">Really hard to change</li><li class="fragment">We can not see the whole picture</li></ol><aside class="notes"><p>в результате</p><p>легко читать</p><p>тяжело менять</p><p>чтобы добавить какую-нибудь фигню надо перелопатить весь проект</p></aside></section><section><img class="plain" src="4829eb617b1dfe8a8fc19d68afdbb26a.png" height="100" style=" padding-right: 70px;"><img class="plain" src="e4b772f4e234cec8f795709cbb47c35f.png" height="100" style=" padding-right: 70px;"><img class="plain" src="2b9750505975ac3e35a15f65a5f22d6c.png" height="100" style=" padding-right: 70px;"><aside class="notes"><p>eсть стартапы с django rails nestjs spring</p><p>там за людей уже подумали как структурировать код</p><p>казалось бы решение проблемы</p></aside></section><section data-background-image="6daa36da08983dfbecfbaddeba0310e4.png" data-background-size="contain" data-background-color="#002B45"><br><aside class="notes"><p>вот приходишь ты в такой стартап, получаешь таску</p><p>идёшь в код</p></aside></section><section><h2>Implicit API</h2><pre><code class="python">class Purchases(viewsets.ModelViewSet):
    queryset = Purchase.objects.all()
    serializer_class = PurchaseSerializer
    permission_classes = (CanPurchase,)
    filter_class = PurchaseFilter</code></pre><pre><code class="python">router.register('/api/purchases/', Purchases)</code></pre><ol><li class="fragment">What exactly does this class do?</li><li class="fragment">How to use it?</li></ol></section><section data-background-image="74cfa36f8f806f2a3ac6ae29e5e574a0.png" data-background-size="contain"><br></section><section><h2>Function to change</h2><pre><code class="python">from google_cloud_messaging import send_message

@observer
def send_sms(event):
    text = 'You purchase something!'
    on_commit(lambda: send_message(text))</code></pre><img class="fragment plain" src="3fd0f970cfcd2f6c03462f23b1046b93.png"><aside class="notes"><p>В документации нет ни слова про вызов нашей функции</p><p>Не ясно как передать в неё нужные нам аргументы</p></aside></section><section><h2>Framework Lifecycle API</h2><ol><li class="fragment">тяжело читать</li><li class="fragment">проще править</li><li class="fragment">надо держать в голове полную картину работы фреймворка</li></ol><img class="plain fragment" src="a62a6e667c84b8c47b931709f966bbd6.png"></section><section><p>в каждом примере мы понятия не имеем что вообще делает наше приложение</p><p>это может быть и бложек и торговая площадка</p><p>наши проекты не имеют связи в внешним миром</p><p>очень много неявных знаний в головах разработчиках</p></section><section><h2>Business-friendly tools</h2><pre><code class="gherkin">Scenario: Publishing the article
  Given I am an author user
  And I have an article
  When I go to the article page</code></pre><pre><code class="python">@given('I am an author user')
def author_user(ctx):
    ctx['user'] = Author()

@given('I have an article')
def article(ctx):
    ctx['article'] = create_article(author=ctx['user'])

@when('I go to the article page')
def go_to_article(ctx):
    Browser().visit(f"/articles/{ctx['article'].id}/")</code></pre></section><section><p>какое у них свойство?</p><p>весь воркфлоу описан на понятном человеческом языке отдельно от реализации</p><p>реализация каждого шага ничего не знает про соседний</p><p>соответственно шаги легко переиспользовать в любом порядке</p><p>их легко менять</p></section><section data-background-image="2cb8eb7a333f341bce653635d00802ce.jpg" data-background-size="contain" data-background-position="left" data-background-color="#000000"><br></section><section><p>что такое ddd</p></section><section><p>ддд есть а инструментов не так много</p></section><section><img class="plain" src="e9d2f1be2ecde86268e9986d5faab8be.png" height="100" style=" padding-right: 70px;"><img class="plain" src="c0084f1e1f33df25ec33ed2e12d076bc.png" height="100" style=" padding-right: 70px;"><img class="plain" src="fa7601d4fe607d2a1c8e8406e09aed5f.png" height="100" style=" padding-right: 70px;"><img class="plain" src="https://raw.githubusercontent.com/dry-python/brand/master/logo/dry-python.png" height="100" style=" padding-right: 70px;"></section><section><p>мы начали пилить dry-python</p><p>набор библиотек, который навязывает писать бизнеслогику</p></section><section><p>сториз</p></section><section><p>пример dsl</p><p>именно dsl начали делать больше случайно</p><p>но потом получили профиты (о них дальше)</p><p>это работает ...</p></section><section><p>пример реализации шагов</p></section><section><p>решение:</p><p>начали отвязывать код того проекта написанного на обсерверах</p><p>мы так же получили раздельные шаги с хорошым переиспользованием</p><p>DDD - тот самый ясный язык</p></section><section><p>жили не тужили всё было хорошо</p><p>всё было в постгресе</p><p>все данные и правила с ними связанные в realtion mapper</p><p>пришёл бизнес</p><p>сказал что так-то так-то интегрируемся переезжаем</p><p>половина данных переехала в firebase</p></section><section><p>google firebase это</p></section><section><p>в результате отвалилась вся возможность работы с данными</p><p>проблема: нет явно прописанных правил о данных, которыми живёт проект</p><p>DDD: нет модели</p></section><section><p>attrs/dataclasses dry-structures lombok</p></section><section><p>начали прописывать в этих самых датаклассах контракты данных</p></section><section><p>захотелось чтобы рантайм проверял эти контракты во время попадания этих переменных в контекст</p><p>а не писать эти проверки как часть сценариев каждый раз</p></section><section><p>уныло перегонять руками таблички бд и ответы api в нормальное представление</p><p>начали писать мапперс</p><p>умеем в django, sqlalchemy, swagger, graphql</p></section><section><p>решение: писать логику отвязанной от data store implementation</p></section><section><p>жили не тужили</p><p>был у нас пушер</p></section><section><p>пушер это ...</p></section><section><p>как обычно используют сторонние библиотеки в проекте?</p><p>импортируем на прямую пихаем им данные так как они того хотят</p><p>в тестах stubим библиотеку и ассертим данные которые им скормили</p></section><section><p>пришёл бизнес</p><p>хотим горантию доставки сообщений</p><p>переезжаем на ably</p></section><section><p>да у них даже апи похоже</p><p>только вот у нас в шагах всё шурупами прикручено к pusher</p><p>давайте ходить по всему проекту менять - на :</p><p>а ещё как будто этого мало поменяем полмилиона ассертов в тастах</p></section><section><p>мы расширили модель данных до stream и event</p><p>добавили интерфейсов для посылки сообщений</p><p>пропихнули их через DI в сториз</p><p>переписали asserts на stream и event</p><p>реализовали новый интерфейс на ably</p></section><section><p>как же мне полегчало когда 2 недели после этого мы навыкатывали новых фич</p><p>в пятницу вечером опять пришёл бизнес</p><p>"фронтендеры не успевают переехать на ably, откатываем на pusher, но чтоб все фичи за 2 недели были"</p><p>Я говорю - 5 минут делов</p></section><section><p>была проблема - внутри шагов всё привязано конкретным сторонним библиотекам</p><p>решение - интерфейсы нас спасут</p><p>предотвратят от протекания ограничений конкретной тулзы в бизнес логики</p></section><section><p>жили не тужили</p><p>но чего-то не хватало</p><p>запилили интеграцию с debug toolbar потомучто сценарий падал на шаге без описания по какой бизнес логике прошёл</p></section><section><p>кто ломал сиай?</p><p>отычно тесты падают assertion error true is not false</p><p>спасибо помог!</p><p>мы напилили интеграцию с test frameworks чтобы показыват какая строчка теста чего выполняла</p></section><section><p>напилили интеграцию с sentry</p></section><section><p>напилим интеграцию с elk</p></section><section><p>подитожим</p><p>было большое приложение с месивом из хаков</p><p>получили меньшее приложение с ясной картиной мира</p><p>соглашения не работаят, работают инструменты</p></section><section data-background-image="a1f23609bebc96401bace638f89491da.jpg" data-background-size="contain" data-background-position="left" data-background-color="#000000"><br></section></div></div><script type="text/javascript" src="reveal.js"></script></body></html>